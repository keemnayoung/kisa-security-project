import json
import re
import streamlit as st
import pandas as pd
import sys, os

# db_helper ê²½ë¡œ ì„¤ì •
sys.path.append(os.path.join(os.path.dirname(__file__), '..', 'components'))
from db_helper import run_query, run_execute

st.set_page_config(page_title="SECURITYCORE - History", page_icon="ğŸ›¡ï¸", layout="wide")

# ìŠ¤íƒ€ì¼ ì„¤ì •
st.markdown("""
<style>
    @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;500;600;700;800&display=swap');
    * { font-family: 'Pretendard', sans-serif !important; }
    .main .block-container { padding-top: 2rem !important; max-width: 1400px !important; }
    .stApp { background: #f8f9fc !important; }
    .page-header {
        font-size: 20px; font-weight: 700; color: #1e293b;
        margin-bottom: 20px; display: flex; align-items: center; gap: 8px;
    }
    .table-container {
        background: white; border-radius: 12px; padding: 20px;
        border: 1px solid #e2e8f0; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
</style>
""", unsafe_allow_html=True)

st.markdown('<div class="page-header">ğŸ›¡ï¸ ì ê²€ ë° ì¡°ì¹˜ ì´ë ¥ í†µí•© ê´€ë¦¬</div>', unsafe_allow_html=True)

tab1, tab2, tab3 = st.tabs(["ğŸ” ì ê²€ ì´ë ¥", "ğŸ”§ ì¡°ì¹˜ ì´ë ¥", "ğŸ“ ì˜ˆì™¸ ê´€ë¦¬"])


def extract_reason_from_raw_evidence(raw_evidence):
    """raw_evidenceì—ì„œ detail ì²« ì¤„(íŒë‹¨ ê·¼ê±°)ì„ ì¶”ì¶œí•œë‹¤."""
    if not raw_evidence:
        return "ì¦ì  ì—†ìŒ"

    # êµ¬ë²„ì „: íŒŒì¼ ê²½ë¡œê°€ ì €ì¥ëœ ê²½ìš°
    if isinstance(raw_evidence, str) and raw_evidence.startswith("/"):
        if os.path.exists(raw_evidence):
            try:
                with open(raw_evidence, "r", encoding="utf-8") as f:
                    payload = json.load(f)
                raw_evidence = payload.get("raw_evidence", raw_evidence)
            except Exception:
                return "ì¦ì  íŒŒì¼ íŒŒì‹± ì‹¤íŒ¨"
        else:
            return "legacy ê²½ë¡œ ë°ì´í„°(íŒŒì¼ ì‚­ì œë¨)"

    parsed = raw_evidence
    for _ in range(3):
        if not isinstance(parsed, str):
            break
        try:
            parsed = json.loads(parsed)
        except Exception:
            break

    if isinstance(parsed, dict):
        detail = str(parsed.get("detail", "")).strip()
        if detail:
            return detail.splitlines()[0].strip()[:300]

    # JSON í˜•ì‹ì´ ê¹¨ì§„ ë¬¸ìì—´ fallback
    if isinstance(raw_evidence, str):
        m = re.search(r'"detail"\s*:\s*"(?P<detail>.*?)"\s*,\s*"target_file"', raw_evidence, re.DOTALL)
        if not m:
            m = re.search(r'"detail"\s*:\s*"(?P<detail>.*?)"\s*(,|\})', raw_evidence, re.DOTALL)
        if m:
            detail = m.group("detail").replace("\\n", "\n").replace('\\"', '"').strip()
            if detail:
                return detail.splitlines()[0].strip()[:300]
        return f"íŒŒì‹± ì‹¤íŒ¨: {raw_evidence[:80].replace(chr(10), ' ')}..."

    return "íŒë‹¨ê·¼ê±° ì¶”ì¶œ ì‹¤íŒ¨"

# ============================================================
# Tab 1: ì ê²€ ì´ë ¥ (ìˆ˜ì •ë¨: LEFT JOIN ì ìš©)
# ============================================================
with tab1:
    # í™œì„±í™”ëœ ì„œë²„ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    servers = run_query("SELECT server_id FROM servers")
    server_list = ['ì „ì²´'] + [s['server_id'] for s in servers] if servers else ['ì „ì²´']

    col1, col2 = st.columns([1, 4])
    with col1:
        sel_server = st.selectbox("ì„œë²„ ì„ íƒ", options=server_list, key="scan_srv")

    # ì¿¼ë¦¬ ì‘ì„± (LEFT JOINì„ ì‚¬ìš©í•˜ì—¬ kisa_itemsì— ì •ë³´ê°€ ì—†ì–´ë„ ë¬´ì¡°ê±´ ì¶œë ¥)
    base_query = """
        SELECT sh.scan_date, sh.server_id, sh.item_code,
               COALESCE(ki.severity, '-') as severity, 
               sh.status,
               sh.raw_evidence
        FROM scan_history sh 
        LEFT JOIN kisa_items ki ON sh.item_code = ki.item_code
    """

    if sel_server == 'ì „ì²´':
        scans = run_query(base_query + " ORDER BY sh.scan_date DESC LIMIT 50")
    else:
        scans = run_query(base_query + " WHERE sh.server_id = %s ORDER BY sh.scan_date DESC LIMIT 50", (sel_server,))

    # ê²°ê³¼ ì¶œë ¥
    if scans:
        df = pd.DataFrame(scans)
        df["reason"] = df["raw_evidence"].apply(extract_reason_from_raw_evidence)
        df = df.rename(columns={
            'scan_date': 'ì ê²€ì¼ì‹œ', 'server_id': 'ì„œë²„', 'item_code': 'ì½”ë“œ',
            'severity': 'ì¤‘ìš”ë„', 'status': 'ê²°ê³¼', 'reason': 'íŒë‹¨ê·¼ê±°'
        })
        st.markdown('<div class="table-container">', unsafe_allow_html=True)
        st.dataframe(df[['ì ê²€ì¼ì‹œ', 'ì„œë²„', 'ì½”ë“œ', 'ì¤‘ìš”ë„', 'ê²°ê³¼', 'íŒë‹¨ê·¼ê±°']], width="stretch", hide_index=True)
        st.markdown('</div>', unsafe_allow_html=True)
    else:
        st.info("ì ê²€ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.")

# ============================================================
# Tab 2: ì¡°ì¹˜ ì´ë ¥ (ì—ëŸ¬ ìˆ˜ì •ë¨: ë³€ìˆ˜ ì •ì˜ í™•ì‹¤í•˜ê²Œ)
# ============================================================
with tab2:
    col1, col2 = st.columns([1, 4])
    with col1:
        sel_server2 = st.selectbox("ì„œë²„ ì„ íƒ", options=server_list, key="fix_srv")

    # ì¡°ì¹˜ ì´ë ¥ ì¿¼ë¦¬ (ì—­ì‹œ LEFT JOIN ì ìš©)
    fix_query = """
        SELECT rl.action_date, rl.server_id, rl.item_code, 
               COALESCE(ki.title, 'í•­ëª© ì„¤ëª… ì—†ìŒ') as title, 
               rl.is_success,
               rl.failure_reason
        FROM remediation_logs rl 
        LEFT JOIN kisa_items ki ON rl.item_code = ki.item_code
    """
    fix_query_legacy = """
        SELECT rl.action_date, rl.server_id, rl.item_code, 
               COALESCE(ki.title, 'í•­ëª© ì„¤ëª… ì—†ìŒ') as title, 
               rl.is_success
        FROM remediation_logs rl 
        LEFT JOIN kisa_items ki ON rl.item_code = ki.item_code
    """

    if sel_server2 == 'ì „ì²´':
        fixes = run_query(fix_query + " ORDER BY rl.action_date DESC LIMIT 50")
        if not fixes:
            fixes = run_query(fix_query_legacy + " ORDER BY rl.action_date DESC LIMIT 50")
    else:
        fixes = run_query(fix_query + " WHERE rl.server_id = %s ORDER BY rl.action_date DESC LIMIT 50", (sel_server2,))
        if not fixes:
            fixes = run_query(fix_query_legacy + " WHERE rl.server_id = %s ORDER BY rl.action_date DESC LIMIT 50", (sel_server2,))

    if fixes:
        df_fix = pd.DataFrame(fixes)
        if 'failure_reason' not in df_fix.columns:
            df_fix['failure_reason'] = None
        df_fix['failure_reason'] = df_fix['failure_reason'].fillna('-')
        df_fix['is_success'] = df_fix['is_success'].map({1: 'âœ… ì„±ê³µ', 0: 'âŒ ì‹¤íŒ¨'})
        df_fix = df_fix.rename(columns={
            'action_date': 'ì¡°ì¹˜ì¼ì‹œ', 'server_id': 'ì„œë²„', 'item_code': 'ì½”ë“œ',
            'title': 'í•­ëª©ëª…', 'is_success': 'ê²°ê³¼', 'failure_reason': 'ì‹¤íŒ¨ì‚¬ìœ '
        })
        st.markdown('<div class="table-container">', unsafe_allow_html=True)
        st.dataframe(df_fix, width="stretch", hide_index=True)
        st.markdown('</div>', unsafe_allow_html=True)
    else:
        st.info("ì¡°ì¹˜ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.")

# ============================================================
# Tab 3: ì˜ˆì™¸ ê´€ë¦¬
# ============================================================
with tab3:
    from datetime import datetime, timedelta

    exceptions = run_query("""
        SELECT e.exception_id, e.server_id, e.item_code, 
               COALESCE(ki.title, 'ì„¤ëª… ì—†ìŒ') as title, 
               e.reason, e.valid_date
        FROM exceptions e 
        LEFT JOIN kisa_items ki ON e.item_code = ki.item_code
        ORDER BY e.valid_date DESC
    """)

    if exceptions:
        df_ex = pd.DataFrame(exceptions)
        df_ex = df_ex.rename(columns={
            'server_id': 'ì„œë²„', 'item_code': 'ì½”ë“œ', 'title': 'í•­ëª©ëª…', 
            'reason': 'ì‚¬ìœ ', 'valid_date': 'ë§Œë£Œì¼'
        })
        st.dataframe(df_ex, width="stretch", hide_index=True)
    else:
        st.info("ë“±ë¡ëœ ì˜ˆì™¸ê°€ ì—†ìŠµë‹ˆë‹¤.")
