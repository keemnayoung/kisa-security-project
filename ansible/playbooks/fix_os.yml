---
# ============================================================
# fix_os.yml: OS 취약점 조치 플레이북
# ============================================================
- name: OS 취약점 조치
  hosts: "{{ target_hosts | default('all') }}"
  become: yes
  gather_facts: no

  vars:
    fix_output_dir: /tmp/audit/fix
    scripts_dir: "{{ playbook_dir }}/../../scripts/os"

  tasks:
    - name: 조치 결과 디렉토리 생성
      file:
        path: "{{ fix_output_dir }}"
        state: directory
        mode: '0755'

    - name: 조치 스크립트 목록 수집
      delegate_to: localhost
      become: no
      find:
        paths: "{{ scripts_dir }}"
        patterns: "fix_U*.sh"
        recurse: yes
      register: fix_scripts

    - name: 조치 스크립트 복사
      copy:
        src: "{{ item.path }}"
        dest: "/tmp/audit/{{ item.path | basename }}"
        mode: '0755'
      loop: "{{ fix_scripts.files }}"

    - name: 조치 스크립트 실행
      shell: "bash /tmp/audit/{{ item.path | basename }}"
      loop: "{{ fix_scripts.files }}"
      register: fix_results

    - name: 조치 결과 JSON 저장
      copy:
        content: "{{ item.stdout }}"
        dest: "{{ fix_output_dir }}/{{ company }}_{{ server_id }}_{{ item.item.path | basename | replace('fix_', '') | replace('.sh', '') }}.json"
      loop: "{{ fix_results.results }}"
      when: item.stdout is defined and item.stdout | length > 0

    - name: 조치 결과 master-node로 수집
      fetch:
        src: "{{ fix_output_dir }}/{{ company }}_{{ server_id }}_{{ item.item.path | basename | replace('fix_', '') | replace('.sh', '') }}.json"
        dest: "{{ fix_output_dir }}/"
        flat: yes
      loop: "{{ fix_results.results }}"
      when: item.stdout is defined and item.stdout | length > 0

    - name: 임시 스크립트 정리
      file:
        path: "/tmp/audit/{{ item.path | basename }}"
        state: absent
      loop: "{{ fix_scripts.files }}"