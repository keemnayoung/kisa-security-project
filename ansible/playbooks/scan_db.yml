---
# ============================================================
# scan_db.yml: DB 취약점 점검 플레이북
# MySQL / PostgreSQL 점검 스크립트 실행
# ============================================================
- name: DB 취약점 점검
  hosts: "{{ target_hosts | default('all') }}"
  become: yes
  gather_facts: no

  vars:
    scan_output_dir: /tmp/audit/check
    scripts_base: "{{ playbook_dir }}/../../scripts/db"
    remote_tmp: /tmp/audit

  tasks:
    # ─── MySQL 점검 (rocky9_mysql 그룹) ───
    - name: "[MySQL] 점검 스크립트 목록 수집"
      delegate_to: localhost
      become: no
      find:
        paths: "{{ scripts_base }}/mysql"
        patterns: "check_D*.sh"
        recurse: yes
      register: mysql_check_scripts
      when: "'rocky9_mysql' in group_names"

    - name: "[MySQL] 점검 스크립트 복사"
      copy:
        src: "{{ item.path }}"
        dest: "{{ remote_tmp }}/{{ item.path | basename }}"
        mode: '0755'
      loop: "{{ mysql_check_scripts.files | default([]) }}"
      when: "'rocky9_mysql' in group_names"

    - name: "[MySQL] 점검 스크립트 실행"
      shell: "bash {{ remote_tmp }}/{{ item.path | basename }}"
      environment:
        MYSQL_USER: root
        MYSQL_PASSWORD: "QWER1234!"
      loop: "{{ mysql_check_scripts.files | default([]) }}"
      register: mysql_check_results
      when: "'rocky9_mysql' in group_names"
      ignore_errors: yes

    # ─── PostgreSQL 점검 (rocky10_postgres 그룹) ───
    - name: "[PostgreSQL] 점검 스크립트 목록 수집"
      delegate_to: localhost
      become: no
      find:
        paths: "{{ scripts_base }}/postgres"
        patterns: "check_D*.sh"
        recurse: yes
      register: pg_check_scripts
      when: "'rocky10_postgres' in group_names"

      # [추가됨] 디렉토리 먼저 만들기 
    - name: "[PostgreSQL] 점검 스크립트 디렉토리 생성"
      file:
        path: "/home/{{ ansible_user }}/kisa-security-project/scripts/db/postgres"
        state: directory
        mode: '0755'
      when: "'rocky10_postgres' in group_names"

    # 1. 점검 스크립트 복사 
    - name: "[PostgreSQL] 점검 스크립트 복사"
      copy:
        src: "{{ item.path }}"
        dest: "/home/{{ ansible_user }}/kisa-security-project/scripts/db/postgres/{{ item.path | basename }}"
        mode: '0755'
      loop: "{{ pg_check_scripts.files | default([]) }}"
      when: "'rocky10_postgres' in group_names"

    # 2. 점검 스크립트 실행 (위랑 100% 똑같은 경로로 실행)
    - name: "[PostgreSQL] 점검 스크립트 실행"
      shell: "bash /home/{{ ansible_user }}/kisa-security-project/scripts/db/postgres/{{ item.path | basename }}"
      loop: "{{ pg_check_scripts.files | default([]) }}"
      register: pg_check_results
      when: "'rocky10_postgres' in group_names"
      ignore_errors: yes

    # ─── 결과 수집 (공통) ───
    - name: 로컬 저장 디렉토리 생성
      file:
        path: "{{ scan_output_dir }}"
        state: directory
        mode: '0755'
      delegate_to: localhost
      become: no
      run_once: true

    - name: "[MySQL] 점검 결과 JSON 저장"
      copy:
        content: "{{ item.stdout }}"
        dest: "{{ scan_output_dir }}/{{ company }}_{{ server_id }}_{{ item.item.path | basename | replace('.sh', '') }}.json"
      delegate_to: localhost
      become: no
      loop: "{{ mysql_check_results.results | default([]) }}"
      when:
        - "'rocky9_mysql' in group_names"
        - item.stdout is defined
        - item.stdout | length > 0

    - name: "[PostgreSQL] 점검 결과 JSON 저장"
      copy:
        content: "{{ item.stdout }}"
        dest: "{{ scan_output_dir }}/{{ company }}_{{ server_id }}_{{ item.item.path | basename | replace('.sh', '') }}.json"
      delegate_to: localhost
      become: no
      loop: "{{ pg_check_results.results | default([]) }}"
      when:
        - "'rocky10_postgres' in group_names"
        - item.stdout is defined
        - item.stdout | length > 0

    # ─── 임시 파일 정리 ───
    - name: 임시 스크립트 정리
      shell: "rm -f {{ remote_tmp }}/check_D*.sh {{ remote_tmp }}/fix_D*.sh {{ remote_tmp }}/run_*.sh {{ remote_tmp }}/_pg_common.sh"
      ignore_errors: yes
